<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche - S5C.01</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">üì∫ S5C.01</a>
            <ul class="nav-links">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="search.html" class="active">Recherche</a></li>
                <li><a href="recommendations.html">Recommandations</a></li>
                <li><a href="series.html">S√©ries</a></li>
                <li><a href="profile.html" id="profileLink">Profil</a></li>
                <li><button id="languageToggle" class="language-toggle all" onclick="toggleLanguage()">üåç Tous</button></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <section class="hero-search">
            <div class="search-hero-content">
                <h1>üîç Rechercher une s√©rie</h1>
                <p class="subtitle">Recherchez par titre ou par mots-cl√©s (crash avion √Æle ‚Üí Lost)</p>
                
                <form class="search-form-modern" onsubmit="performSearch(event)">
                    <div class="search-input-wrapper">
                        <input type="text" id="searchQuery" placeholder="Rechercher une s√©rie... (ex: lost, crash avion, breaking bad)" required>
                        <button type="submit" class="btn btn-primary">üîç Rechercher</button>
                    </div>
                    
                    <div class="search-filters">
                        <div class="filter-item">
                            <label for="searchLanguage">üåç Langue</label>
                            <select id="searchLanguage">
                                <option value="">Toutes</option>
                                <option value="vf">VF</option>
                                <option value="vo">VO</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label for="searchTop">üìä R√©sultats</label>
                            <select id="searchTop">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </form>
                
                <div class="search-tips">
                    <p><strong>üí° Astuce :</strong> La recherche est intelligente et cherche dans les titres ET les mots-cl√©s</p>
                </div>
            </div>
        </section>

        <section id="resultsSection" style="display: none;">
            <h2>R√©sultats de recherche</h2>
            <div id="searchResults" class="series-grid"></div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 TV Series - SAE501 Project</p>
        </div>
    </footer>

    <script src="app.js"></script>
    <script>
        // Charger la recherche depuis l'URL si pr√©sente
        document.addEventListener('DOMContentLoaded', () => {
            updateLanguageToggle();
            const params = getUrlParams();
            if (params.q) {
                document.getElementById('searchQuery').value = params.q;
                if (params.language) {
                    document.getElementById('searchLanguage').value = params.language;
                }
                if (params.top) {
                    document.getElementById('searchTop').value = params.top;
                }
                performSearch(null, params.q);
            }
        });

        async function performSearch(event, queryOverride = null) {
            if (event) event.preventDefault();
            
            const query = queryOverride || document.getElementById('searchQuery').value;
            const language = document.getElementById('searchLanguage').value;
            const top = document.getElementById('searchTop').value;
            
            const resultsSection = document.getElementById('resultsSection');
            const resultsDiv = document.getElementById('searchResults');
            
            resultsSection.style.display = 'block';
            resultsDiv.innerHTML = showLoading();
            
            try {
                // RECHERCHE FUSIONN√âE INTELLIGENTE : Titre en priorit√© + TF-IDF
                let resultsMap = new Map(); // Utiliser Map pour √©viter doublons et scorer
                const queryLower = query.toLowerCase().trim();
                
                // 1. Recherche par titre (PRIORIT√â)
                let titleUrl = `/api/series/search?query=${encodeURIComponent(query)}`;
                if (language) titleUrl += `&language=${language}`;
                titleUrl += `&limit=${top}`;
                
                try {
                    const titleResponse = await apiRequest(titleUrl, { requireAuth: false });
                    const titleResults = titleResponse.series || titleResponse || [];
                    
                    titleResults.forEach(series => {
                        const titleLower = series.title.toLowerCase();
                        const baseName = titleLower.replace(/_vf$|_vo$/, '');
                        
                        // Score bas√© sur la correspondance du titre
                        let score = 0;
                        if (baseName === queryLower) {
                            score = 1000; // Correspondance exacte
                        } else if (baseName.startsWith(queryLower)) {
                            score = 900; // Commence par la requ√™te
                        } else if (baseName.includes(queryLower)) {
                            score = 800; // Contient la requ√™te
                        } else {
                            score = 700; // Correspondance partielle
                        }
                        
                        resultsMap.set(series.title, { ...series, searchScore: score });
                    });
                } catch (e) {
                    console.log('Recherche par titre √©chou√©e:', e);
                }
                
                // 2. Recherche TF-IDF par mots-cl√©s (COMPL√âMENT)
                let tfidfUrl = `/api/search?q=${encodeURIComponent(query)}&limit=${top}`;
                if (language) tfidfUrl += `&language=${language}`;
                
                try {
                    const tfidfData = await apiRequest(tfidfUrl, { requireAuth: false });
                    const tfidfResults = tfidfData.results || [];
                    
                    tfidfResults.forEach(series => {
                        if (!resultsMap.has(series.title)) {
                            // Ajouter avec score TF-IDF (score < 10 g√©n√©ralement)
                            const tfidfScore = series.score || 0;
                            resultsMap.set(series.title, { ...series, searchScore: tfidfScore });
                        }
                    });
                } catch (e) {
                    console.log('Recherche TF-IDF √©chou√©e:', e);
                }
                
                // 3. Convertir en array et trier par score d√©croissant
                let allResults = Array.from(resultsMap.values());
                allResults.sort((a, b) => b.searchScore - a.searchScore);
                
                // 4. Limiter au nombre de r√©sultats demand√©s
                allResults = allResults.slice(0, parseInt(top));
                
                if (allResults.length === 0) {
                    resultsDiv.innerHTML = showNoResults('Aucune s√©rie trouv√©e pour ces crit√®res.');
                    return;
                }
                
                resultsDiv.innerHTML = allResults.map(s => createSeriesCard(s, { showRating: false })).join('');
                
                // Mettre √† jour l'URL sans recharger la page
                const newUrl = `search.html?q=${encodeURIComponent(query)}${language ? '&language=' + language : ''}&top=${top}`;
                window.history.pushState({}, '', newUrl);
                
            } catch (error) {
                resultsDiv.innerHTML = showError('Erreur lors de la recherche. Veuillez r√©essayer.');
            }
        }
    </script>
</body>
</html>
